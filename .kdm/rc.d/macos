# Functions: macOS-only (regardless of GNU conversion)

# Bounce if we're not on Darwin
[[ "${UNAME_KERNEL_NAME}" != "Darwin" ]] && return 0


[[ "${_}" != "${0}" && "${SOURCE_VERBOSE}" == "true" ]] && output kv "Loaded" "${BASH_SOURCE[@]/$HOME\/\.kdm\//}"


# PING_WAIT for use in ping functions
export PING_WAIT="-t 1"


# Hostname change function
_macos_hostname() {
	# Declare vars as local
	local USAGE_STRING

	USAGE_STRING="hostname-macos <new hostname>"
	[[ -z "${1}" ]] && output usage "${USAGE_STRING}" && return

	_macos_scutil_set "ComputerName"  "${1}"
	_macos_scutil_set "HostName"      "${1}"
	_macos_scutil_set "LocalHostName" "${1%%.*}"

	output green "Hostname set to '${1}' / '${1%%.*}'"
}

_macos_itunes_osascript() {
	osascript -e 'tell application "iTunes"' -e "${1}" -e 'end tell' 2> /dev/null
}

# iTunes control
_macos_itunes_control() {
	# Declare vars as local
	local ARRAY_USAGE_OPTIONS USAGE_OPTIONS_STRING USAGE_STRING

	# Array of options
	ARRAY_USAGE_OPTIONS=(
	next
	pause
	play
	prev
	)

	# Create variable of pipe-separated options from array
	USAGE_OPTIONS_STRING="$(IFS=$'|'; echo "${ARRAY_USAGE_OPTIONS[*]}")"

	USAGE_STRING="itunes <${USAGE_OPTIONS_STRING}>"

	case "${1}" in
		pause|play) _macos_itunes_osascript "playpause"  && output green "Playback toggled" ;;
		next)       _macos_itunes_osascript "next track" && output green "Skipped next"     ;;
		prev)       _macos_itunes_osascript "back track" && output green "Skipped previous" ;;

		*)
			output usage "${USAGE_STRING}"
			return
	esac

	_macos_itunes
}

# iTunes information
_macos_itunes() {
	# Declare vars as local
	local ITUNES_ALBUM ITUNES_ARTIST ITUNES_KIND ITUNES_NA ITUNES_NAME ITUNES_STATE

	ITUNES_ALBUM="$( _macos_itunes_osascript 'get album  of current track')"
	ITUNES_ARTIST="$(_macos_itunes_osascript 'get artist of current track')"
	ITUNES_KIND="$(  _macos_itunes_osascript 'get kind   of current track')"
	ITUNES_NAME="$(  _macos_itunes_osascript 'get name   of current track')"
	ITUNES_STATE="$( _macos_itunes_osascript 'get album  of current track')"

	ITUNES_NA="Not available"

	[[ -z "${ITUNES_ALBUM}"  ]] && ITUNES_ALBUM="${ITUNES_NA}"
	[[ -z "${ITUNES_ARTIST}" ]] && ITUNES_ARTIST="${ITUNES_NA}"
	[[ -z "${ITUNES_KIND}"   ]] && ITUNES_KIND="${ITUNES_NA}"
	[[ -z "${ITUNES_NAME}"   ]] && ITUNES_NAME="${ITUNES_NA}"
	[[ -z "${ITUNES_STATE}"  ]] && ITUNES_STATE="${ITUNES_NA}"

	output purple "--------= Currently ${ITUNES_STATE} =--------"
	echo

	output kv "  Name" "${ITUNES_NAME-Nothing}"
	output kv "Artist" "${ITUNES_ARTIST-Nothing}"
	output kv " Album" "${ITUNES_ALBUM-Nothing}"
	output kv "  Kind" "${ITUNES_KIND-Nothing}"
}

# Fake lsusb function
_macos_lsusb() {
	_macos_system_profiler 'USB'
}

# Volume config function
_macos_volume() {
	# Declare vars as local
	local ARRAY_USAGE_OPTIONS USAGE_OPTIONS_STRING VOLUME_CLEAN VOLUME_CURRENT VOLUME_MUTE

	# Array of options
	ARRAY_USAGE_OPTIONS=(
	mute
	max
	up
	down
	'[0-100]'
	)

	# Create variable of pipe-separated options from array
	USAGE_OPTIONS_STRING="$(IFS=$'|'; echo "${ARRAY_USAGE_OPTIONS[*]}")"

	VOLUME_CURRENT="$(osascript -e '    output volume of (get volume settings)')"
	VOLUME_MUTE="$(   osascript -e 'get output muted  of (get volume settings)')"

	# Make sure it's doesn't have any missing values
	if [[ "${VOLUME_CURRENT}" == *"missing"* || "${VOLUME_MUTE}" == *"missing"* ]]; then
		output error "Unable to detect current volume"
		return
	fi

	if [[ -z "${1}" ]]; then
		output usage "volume [${FUNCNAME[*]}] <${USAGE_OPTIONS_STRING}>"
		echo
		output kv "Current volume" "${VOLUME_CURRENT}%"
		output kv "   Mute status" "${VOLUME_MUTE}"
		return
	fi

	case "${1}" in
		mute)
			if [[ "${VOLUME_MUTE}" == "false" ]]; then
				osascript -e 'set volume with output muted'
				output red "Volume muted"
				return
			fi

			osascript -e 'set volume without output muted'
			output green "Volume unmuted"
			;;

		max)
			osascript -e 'set volume output volume 100'
			output green "Volume set to 100%"
			;;

		up)
			if [[ "${VOLUME_CURRENT}" -lt "95" ]]; then
				osascript -e "set volume output volume $((VOLUME_CURRENT+5))"
				output green "Volume set to $((VOLUME_CURRENT+5))%"
				return
			fi

			if [[ "${VOLUME_CURRENT}" -ge "95" && "${VOLUME_CURRENT}" -lt "100" ]]; then
				osascript -e 'set volume output volume 100'
				output green "Volume set to 100%"
				return
			fi

			output red "Volume is already set to ${VOLUME_CURRENT}%"
			;;

		down)
			if [[ "${VOLUME_CURRENT}" -gt "5" ]]; then
				osascript -e "set volume output volume $((VOLUME_CURRENT-5))"
				output green "Volume set to $((VOLUME_CURRENT-5))%"
				return
			fi

			if [[ "${VOLUME_CURRENT}" -le "5" && "${VOLUME_CURRENT}" -gt "0" ]]; then
				osascript -e 'set volume output volume 0'
				output green "Volume set to 0%"
				return
			fi

			output red "Volume is already set to ${VOLUME_CURRENT}%"
			;;

		*)
			VOLUME_CLEAN="${1//[^0-9]}"
			if [[ "${#VOLUME_CLEAN}" == "0" || "${#VOLUME_CLEAN}" -gt "100" ]]; then
				output red "Invalid volume entered"
				return
			fi

			osascript -e "set volume output volume ${VOLUME_CLEAN}"
			output green "Volume set to ${VOLUME_CLEAN}%"
			;;
	esac

	# Play volume change sound effect
	# VOLUME_SOUND_EFFECT="/System/Library/LoginPlugins/BezelServices.loginPlugin/Contents/Resources/volume.aiff"
	# {
	# 	afplay "${VOLUME_SOUND_EFFECT}" & disown
	# } &> /dev/null
}

# Reset all Office Mac 2011 files
_macos_fix_office_2011() {
	# Declare vars as local
	local ARRAY_RESET_FILES PTH_AS PTH_CHE PTH_LIB PTH_PRF RESET_YN

	# Check if they're sure
	read -r -p "Are you sure? [Y/n] " RESET_YN
	echo
	[[ "${RESET_YN}" == [Nn] ]] && output purple "No changes" && return

	PTH_LIB="${HOME}/Library"
	PTH_AS="${PTH_LIB}/Application Support"
	PTH_CHE="${PTH_LIB}/Caches"
	PTH_PRF="${PTH_LIB}/Preferences"

	ARRAY_RESET_FILES=(
	"${HOME}/Documents/Microsoft User Data"
	"${PTH_AS}/CrashReporter/Microsoft"*
	"${PTH_AS}/Microsoft"
	"${PTH_AS}/com.apple.sharedfilelist/com.apple.LSSharedFileList.ApplicationRecentDocuments/com.microsoft."*
	"${PTH_CHE}/Microsoft"
	"${PTH_CHE}/com.apple.helpd/Generated/com.microsoft."*
	"${PTH_CHE}/com.apple.helpd/SDMHelpData/Other/English/HelpSDMIndexFile/com.microsoft."*
	"${PTH_CHE}/com.microsoft."*
	"${PTH_PRF}/Microsoft"
	"${PTH_PRF}/com.microsoft."*
	)

	output red "Resetting all Microsoft Office data"
	rm -rf "${ARRAY_RESET_FILES[@]}"

	defaults delete com.microsoft.Outlook &> /dev/null
	killall -9 cfprefsd                   &> /dev/null

	output green "Complete; you should reboot, preferably"
}

_macos_notify() {
	# Declare vars as local
	local NOTIFY_MESSAGE NOTIFY_SUBTITLE NOTIFY_TITLE USAGE_STRING

	NOTIFY_TITLE="${1}"
	NOTIFY_MESSAGE="${2}"
	NOTIFY_SUBTITLE="${3}"

	USAGE_STRING="notify <title> <message> [<subtitle>]"
	[[ -z "${NOTIFY_TITLE}" || -z "${NOTIFY_MESSAGE}" ]] && output usage "${USAGE_STRING}" && return

	# Add subtitle to osascript string if present
	[[ "${NOTIFY_SUBTITLE}" ]] && NOTIFY_SUBTITLE="subtitle \"${NOTIFY_SUBTITLE}\""

	osascript -e "display notification \"${NOTIFY_MESSAGE}\" with title \"${NOTIFY_TITLE}\" ${NOTIFY_SUBTITLE}"
}

_macos_scutil_set() {
	sudo scutil --set "${1}" "${2}"
}

# JSON version of system_profiler
_macos_system_profiler() {
	# Declare vars as local
	local USAGE_STRING

	# Check dependencies
	if ! hash jq; then
		output error "Could not detect jq binary, try 'brew install jq'"
		return
	fi

	if ! hash plist-to-json; then
		output error "Could not detect plist-to-json binary, try 'npm -g i plist-to-json'"
		return
	fi

	if ! hash system_profiler; then
		output error "Could not detect system_profiler binary, try running macOS"
		return
	fi

	# Check argument
	USAGE_STRING="system-profiler <data type (name only, no SP prefix or DataType suffix)>"
	[[ -z "${1}" ]] && output usage "${USAGE_STRING}" && return

	plist-to-json <(sudo system_profiler -xml "SP${1}DataType" 2> /dev/null | sed -E -e 's/\s{1,}<\//<\//g' -e 's/\ \ /\ /g') | sed -e 's/"attrib_Yes"/true/g' -e 's/"attrib_No"/false/g' -e 's/"attrib_On"/true/g' -e 's/"attrib_Off"/false/g' -e 's/"_items"/"items"/g' -e 's/"_name"/"name"/g' | jq -S '.[][].items'
}

# List formatted system_profiler data types
_macos_system_profiler_list() {
	>&2 output blue "Available data types:"
	>&2 echo
	sudo system_profiler -listDataTypes | grep -Ev 'Available\ Datatypes:' | sed -e 's/^SP//g' -e 's/DataType$//g' | sort -df
}


# EFI partition mount for disk0, disk1, and disk2
for NUM in {0..3}; do
	DSK="disk${NUM}s1"
	PATH_DSK="/dev/${DSK}"
	PATH_MNT="/Volumes/${DSK}"

	[[ ! -b "${PATH_DSK}" ]] && continue

	# shellcheck disable=SC2139
	# shellcheck disable=SC2140
	alias "efi-mount-${NUM}"="sudo mkdir ${PATH_MNT} && diskutil mount -mountPoint ${PATH_MNT} ${PATH_DSK} && cd ${PATH_MNT}"
done

# Show listening ports a bit easier
alias net-listening-ipv4="netstat -an | grep -E '^..p4.*.LISTEN' | sort"
alias net-listening-ipv6="netstat -an | grep -E '^..p6.*.LISTEN' | sort"

# Fake lspci
if hash dspci && ! hash lspci; then alias lspci='dspci'; fi

# Fake lsusb
alias lsusb='_macos_lsusb'

# Clear font cache
alias fix-fontcache='sudo atsutil databases -remove'

# Lock screen and screensaver shortcuts
alias screen-off='  pmset displaysleepnow'
alias screen-lock=' /System/Library/CoreServices/Menu\ Extras/User.menu/Contents/Resources/CGSession -suspend'
alias screen-saver='open -a ScreenSaverEngine'

alias sleep-system="osascript -e 'tell app \"System Events\" to sleep'"

# El Capitan and up
if [[ "${UNAME_KERNEL_RELEASE%%.*}" -ge "15" ]]; then
	# Enable and disable indexing
	alias indexing-enable=' sudo mdutil -a -i on'
	alias indexing-disable='sudo mdutil -a -i off'

	# Flush DNS cache
	alias fix-dns='sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder'
else # Pre-El Capitan
	alias fix-dns='sudo killall -HUP mDNSResponder'
	alias fix-diskperms="sudo diskutil repairPermissions /; sudo chown -R \${USER} /usr/local"
fi

# Yosemite/El Capitan
if [[ "${UNAME_KERNEL_RELEASE%%.*}" == "14" || "${UNAME_KERNEL_RELEASE%%.*}" == "15" ]]; then
	# Fix disk permissions
	alias fix-diskperms="sudo repair_packages --repair --standard-pkgs /; sudo chown -R \${USER} /usr/local"
fi


# Function aliases
alias hostname-macos='_macos_hostname'

alias itunes-control='      _macos_itunes_control'
alias itunes-control-macos='_macos_itunes_control'

alias itunes='      _macos_itunes'
alias itunes-macos='_macos_itunes'

alias notify='      _macos_notify'
alias notify-macos='_macos_notify'

alias fix-office-2011='_macos_fix_office_2011'

alias scutil-set='_macos_scutil_set'

alias system-profiler='     _macos_system_profiler'
alias system-profiler-list='_macos_system_profiler_list'

alias volume-macos='_macos_volume'
alias volume='      _macos_volume'


# vim: set syntax=sh filetype=sh ts=2 sw=2 tw=0 noet :
